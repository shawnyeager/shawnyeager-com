#!/bin/bash
# pre-commit hook for Hugo site repos
# 1. Blocks commits on master (must use feature branches)
# 2. Blocks replace directives in go.mod (breaks Netlify builds)
# 3. Lints staged content files with Vale (prose style)

# Skip in CI/automated contexts
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
    exit 0
fi

# Block commits on master branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "master" ]; then
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "ERROR: Cannot commit directly to master!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Site changes must go through PRs with deploy previews."
    echo ""
    echo "TO FIX:"
    echo "  git checkout -b feature-name    # Create a feature branch"
    echo "  git add -A && git commit        # Commit your changes"
    echo "  git push -u origin feature-name # Push branch"
    echo "  gh pr create --fill             # Create PR"
    echo ""
    echo "This commit has been BLOCKED."
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    exit 1
fi

# Check if go.mod is staged for commit
if git diff --cached --name-only | grep -q "^go.mod$"; then
    # Check the staged content (not working tree) for replace directive
    if git show :go.mod 2>/dev/null | grep -q "^replace.*tangerine-theme"; then
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "ERROR: Cannot commit go.mod with replace directive!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "Replace directives are for LOCAL TESTING ONLY."
        echo "Netlify cannot access ../tangerine-theme and builds will fail."
        echo ""
        echo "TO FIX:"
        echo "  git restore go.mod        # Remove replace directive"
        echo "  git add go.mod            # Re-stage the clean version"
        echo ""
        echo "Or unstage go.mod from this commit:"
        echo "  git restore --staged go.mod"
        echo ""
        echo "This commit has been BLOCKED."
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        exit 1
    fi
fi

# Lint staged content files with Vale
STAGED_MD=()
while IFS= read -r -d '' file; do
    STAGED_MD+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACM -z | grep -z '^content/.*\.md$')
if [ ${#STAGED_MD[@]} -gt 0 ]; then
    # Activate mise so vale is on PATH
    eval "$(mise activate bash 2>/dev/null)" 2>/dev/null
    if ! command -v vale &>/dev/null; then
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "WARNING: Vale is not installed. Prose linting skipped."
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "TO INSTALL:"
        echo "  mise install vale"
        echo "  vale sync"
        echo ""
    else
        VALE_OUTPUT=$(vale "${STAGED_MD[@]}" 2>&1)
        VALE_EXIT=$?
        if [ $VALE_EXIT -ne 0 ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "ERROR: Vale found prose issues in staged content!"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "$VALE_OUTPUT"
            echo ""
            echo "TO FIX: Resolve the issues above, then re-stage and commit."
            echo ""
            echo "This commit has been BLOCKED."
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 1
        fi
    fi
fi

exit 0
