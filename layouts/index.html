{{/*
Purpose: Homepage for shawnyeager.com

Features:
- Bio section from index.md content (includes CTA via shortcode)
- Featured or latest essay display
- Recent writing listing (5 most recent, mixed essays + notes)

Logic:
- Shows featured essay if one has featured: true in frontmatter
- Otherwise shows most recent essay
- Recent section merges essays and notes chronologically
- Filters drafts in production

Important Notes:
- Overrides theme default index.html
- Bio content and CTA come from /content/_index.md
*/}}

{{ define "main" }}
    <!-- Bio -->
    <div class="site-intro">
        {{ with .Params.headline }}<h1 class="display-title">{{ . | safeHTML }}</h1>{{ end }}
        {{ with .Params.tagline }}<p class="intro-tagline">{{ . }}</p>{{ end }}
        {{ with .Params.sectors }}<p class="intro-sectors">{{ . }}</p>{{ end }}
        <div class="intro-body">
            {{ .Content | safeHTML }}
        </div>
    </div>

    <!-- Featured or Latest Essay -->
    {{ $essays := where .Site.RegularPages "Type" "essays" }}
    {{ if and (not hugo.IsServer) (eq hugo.Environment "production") }}
    {{ $essays = where $essays "Draft" false }}
    {{ end }}
    {{ $featuredPost := where $essays "Params.featured" true }}
    {{ $latestPost := index $essays 0 }}
    {{ $isFeatured := false }}
    {{ if $featuredPost }}
        {{ $latestPost = index $featuredPost 0 }}
        {{ $isFeatured = true }}
    {{ end }}
    {{ with $latestPost }}
    <h2 class="essay-section-header">{{ if $isFeatured }}Featured Essay{{ else }}Latest Essay{{ end }}</h2>
    <article class="latest-essay">
        <header>
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
        </header>
        <p>{{ with .Params.summary }}{{ . | safeHTML }}{{ else }}{{ .Summary }}{{ end }}</p>
        <footer>
            {{- partial "links/action.html" (dict "url" .RelPermalink "text" "Read more" "event" $.Site.Params.plausible_events.essay_cta) -}}
        </footer>
    </article>
    {{ end }}

    <!-- Recent Writing (mixed essays + notes) -->
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ if and (not hugo.IsServer) (eq hugo.Environment "production") }}
    {{ $notes = where $notes "Draft" false }}
    {{ end }}
    {{ $allWriting := union $essays $notes }}
    {{ $allWriting = sort $allWriting "Date" "desc" }}

    {{/* Remove the featured/latest essay already shown above */}}
    {{ $recentWriting := slice }}
    {{ range $allWriting }}
        {{ if ne .Permalink $latestPost.Permalink }}
            {{ $recentWriting = $recentWriting | append . }}
        {{ end }}
    {{ end }}

    {{ if $recentWriting }}
    <section class="recent-essays">
        <h2 class="section-label-small">Recent Writing</h2>
        {{ range first 5 $recentWriting }}
        {{ $singular := cond (eq .Type "notes") "note" "essay" }}
        <article class="{{ $singular }}-item">
            <a href="{{ .RelPermalink }}">
                <time datetime="{{ .Date.Format "2006-01-02" }}" class="{{ $singular }}-date">{{ .Date.Format "2006 Â· 01" }}</time>
                <span class="{{ $singular }}-title">{{ .Title }}</span>
            </a>
        </article>
        {{ end }}
        <div class="all-essays">{{- partial "links/action.html" (dict "url" ("/writing/" | relURL) "text" "All writing" "event" .Site.Params.plausible_events.all_writing) -}}</div>
    </section>
    {{ end }}
{{ end }}
