{{/*
Purpose: Homepage for shawnyeager.com - The Gallery

Features:
- Bio section from index.md content (includes CTA via shortcode)
- Featured or latest essay display
- Podcast feature section
- Recent essays listing (5 most recent)
- Topic browsing

Logic:
- Shows featured essay if one has featured: true in frontmatter
- Otherwise shows most recent essay
- Filters drafts in production
- Topic list via topic-list.html partial

Important Notes:
- Overrides theme default index.html
- Bio content and CTA come from /content/_index.md
*/}}

{{ define "main" }}
    <!-- Bio -->
    <div class="site-intro">
        {{ with .Params.headline }}<h1 class="display-title">{{ . }}</h1>{{ end }}
        {{ .Content | safeHTML }}
    </div>

    <!-- Featured or Latest Essay -->
    {{ $posts := where .Site.RegularPages "Type" "essays" }}
    {{ if not hugo.IsServer }}
    {{ $posts = where $posts "Draft" false }}
    {{ end }}
    {{ $featuredPost := where $posts "Params.featured" true }}
    {{ $latestPost := index $posts 0 }}
    {{ $isFeatured := false }}
    {{ if $featuredPost }}
        {{ $latestPost = index $featuredPost 0 }}
        {{ $isFeatured = true }}
    {{ end }}
    {{ with $latestPost }}
    <h2 class="essay-section-header">{{ if $isFeatured }}Featured Essay{{ else }}Latest Essay{{ end }}</h2>
    <article class="latest-essay">
        <header>
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
        </header>
        {{ with .Params.summary }}<p>{{ . }}</p>{{ else }}{{ .Summary }}{{ end }}
        <footer>
            {{- partial "links/action.html" (dict "url" .RelPermalink "text" "Read more" "event" $.Site.Params.plausible_events.essay_cta) -}}
        </footer>
    </article>
    {{ end }}

    <!-- Podcast Feature Box -->
    {{/* Fetch RSS - use date-based cache key for daily refresh */}}
    {{ $episode := false }}
    {{ $cacheKey := print "v2-" .Site.Params.podcast_rss (now.Format "2006-01-02") }}
    {{ with try (resources.GetRemote .Site.Params.podcast_rss (dict "key" $cacheKey)) }}
        {{ with .Value }}
            {{ $feed := . | transform.Unmarshal }}
            {{/* Check for early-access episode first, then fall back to regular item */}}
            {{ with $feed.channel.paidItem }}
                {{ $episode = . }}
            {{ else }}
                {{ $episode = index $feed.channel.item 0 }}
            {{ end }}
        {{ end }}
    {{ end }}

    {{ if $episode }}
    <h2 class="essay-section-header">Latest Episode</h2>
    {{ end }}
    <section class="podcast">
        <div class="podcast-header">
            <img src="/images/trust-revolution-cover.webp" alt="Trust Revolution Podcast cover art" class="podcast-art" width="150" height="150" fetchpriority="high">
            <div class="podcast-info">
                {{ with $episode }}
                {{/* Extract S##E## tag and parse guest/subtitle */}}
                {{ $epTag := "" }}
                {{ with findRE `^S\d+E\d+` .title }}
                    {{ $epTag = index . 0 }}
                {{ end }}
                {{ $cleaned := replaceRE `^S\d+E\d+\s*` "" .title }}
                {{/* Normalize both em dash (—) and en dash (–) to consistent delimiter */}}
                {{ $normalized := replaceRE `\s*[–—]\s*` " – " $cleaned }}
                {{ $parts := split $normalized " – " }}
                {{ $guest := "" }}
                {{ $subtitle := $normalized }}
                {{ if gt (len $parts) 1 }}
                    {{ $guest = index $parts 0 }}
                    {{ $subtitle = index $parts 1 }}
                {{ end }}
                {{/* Handle solo eps: "– Title" leaves empty guest */}}
                {{ if eq $guest "" }}
                    {{ $subtitle = replaceRE `^–\s*` "" $subtitle }}
                {{ end }}
                <div class="episode-info">
                    <span class="episode-hook">{{ $subtitle }}</span>
                    <span class="episode-meta">{{ if ne $guest "" }}<span class="episode-guest">with {{ $guest }}</span>{{ if $epTag }}<span class="separator">·</span>{{ end }}{{ end }}{{ if $epTag }}<span class="episode-tag">{{ $epTag }}</span>{{ end }}</span>
                </div>
                {{ end }}
                <div class="podcast-links">
                    {{ partial "links/action.html" (dict "url" .Site.Params.podcast_url "text" "Listen now" "event" .Site.Params.plausible_events.podcast_external) }}
                    {{ partial "links/action.html" (dict "url" ("podcast" | relURL) "text" "Subscribe" "event" .Site.Params.plausible_events.podcast_subscribe) }}
                </div>
            </div>
        </div>
    </section>

      <!-- Recent Essays -->
      {{/* Exclude featured essay from list to avoid duplication */}}
      {{ $recentPosts := where $posts "Params.featured" "!=" true }}
      {{/* If no featured, skip the first (already shown as Latest) */}}
      {{ if not $isFeatured }}
          {{ $recentPosts = after 1 $posts }}
      {{ end }}
      {{ if $recentPosts }}
      <section class="recent-essays">
          <h2 class="section-label-small">Recent Essays</h2>
         {{ range first 5 $recentPosts }}
         <article class="essay-item">
             <a href="{{ .RelPermalink }}">
                 <time datetime="{{ .Date.Format "2006-01-02" }}" class="essay-date">{{ .Date.Format "2006 · 01" }}</time>
                 <span class="essay-title">{{ .Title }}</span>
             </a>
         </article>
         {{ end }}
         <div class="all-essays">{{- partial "links/action.html" (dict "url" ("essays" | relURL) "text" "All essays" "event" .Site.Params.plausible_events.all_essays) -}}</div>
     </section>
      {{ else }}
      <section class="recent-essays">
          <h2 class="section-label-small">Recent Essays</h2>
          <p>No essays published yet.</p>
      </section>
      {{ end }}
{{ end }}
