{{/*
Purpose: Homepage for shawnyeager.com - The Gallery

Features:
- Bio section from index.md content (includes CTA via shortcode)
- Featured or latest essay display
- Podcast feature section
- Recent essays listing (5 most recent)
- Topic browsing

Logic:
- Shows featured essay if one has featured: true in frontmatter
- Otherwise shows most recent essay
- Filters drafts in production
- Topic list via topic-list.html partial

Important Notes:
- Overrides theme default index.html
- Bio content and CTA come from /content/_index.md
*/}}

{{ define "main" }}
    <!-- Bio -->
    <div class="bio">
        {{ .Content | safeHTML }}
    </div>

    <!-- Featured or Latest Essay -->
    {{ $posts := where .Site.RegularPages "Type" "essays" }}
    {{ if not hugo.IsServer }}
    {{ $posts = where $posts "Draft" false }}
    {{ end }}
    {{ $featuredPost := where $posts "Params.featured" true }}
    {{ $latestPost := index $posts 0 }}
    {{ $isFeatured := false }}
    {{ if $featuredPost }}
        {{ $latestPost = index $featuredPost 0 }}
        {{ $isFeatured = true }}
    {{ end }}
    {{ with $latestPost }}
    <article class="latest-essay">
        <header>
            <h2 class="essay-section-header">{{ if $isFeatured }}Featured Essay{{ else }}Latest Essay{{ end }}</h2>
            <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
        </header>
        {{ .Summary }}
        <footer>
            <a href="{{ .RelPermalink }}" class="cta-link{{ with $.Site.Params.plausible_events.essay_cta }} plausible-event-name={{ . }}{{ end }}"><span class="link-text">Read more</span> <span aria-hidden="true">→</span></a>
        </footer>
    </article>
    {{ end }}

    <!-- Podcast Feature Box -->
    {{/* Fetch RSS to check if we have an episode */}}
    {{ $episode := false }}
    {{ $cacheKey := print .Site.Params.podcast_rss (now.Unix) }}
    {{ with try (resources.GetRemote .Site.Params.podcast_rss (dict "key" $cacheKey)) }}
        {{ with .Value }}
            {{ $feed := . | transform.Unmarshal }}
            {{ $episode = index $feed.channel.item 0 }}
        {{ end }}
    {{ end }}

    {{ if $episode }}
    <h2 class="essay-section-header">Latest Episode</h2>
    {{ end }}
    <section class="podcast">
        <div class="podcast-header">
            <img src="/images/trust-revolution-cover.webp" alt="Trust Revolution Podcast cover art" class="podcast-art" width="150" height="150" fetchpriority="high">
            <div class="podcast-info">
                {{ with $episode }}
                {{/* Extract S##E## tag and parse guest/subtitle */}}
                {{ $epTag := "" }}
                {{ with findRE `^S\d+E\d+` .title }}
                    {{ $epTag = index . 0 }}
                {{ end }}
                {{ $cleaned := replaceRE `^S\d+E\d+\s*` "" .title }}
                {{ $parts := split $cleaned " – " }}
                {{ $guest := "" }}
                {{ $subtitle := $cleaned }}
                {{ if gt (len $parts) 1 }}
                    {{ $guest = index $parts 0 }}
                    {{ $subtitle = index $parts 1 }}
                {{ end }}
                {{/* Handle solo eps: "– Title" leaves empty guest */}}
                {{ if eq $guest "" }}
                    {{ $subtitle = replaceRE `^–\s*` "" $subtitle }}
                {{ end }}
                <div class="episode-info">
                    <span class="episode-hook">{{ $subtitle }}</span>
                    <span class="episode-meta">{{ if ne $guest "" }}<span class="episode-guest">with {{ $guest }}</span>{{ end }}{{ if $epTag }}<span class="separator">·</span><span class="episode-tag">{{ $epTag }}</span>{{ end }}</span>
                </div>
                {{ end }}
                <div class="podcast-links">
                    <a href="{{ .Site.Params.podcast_url }}" target="_blank"{{ with .Site.Params.plausible_events.podcast_external }} class="plausible-event-name={{ . }}"{{ end }}><span class="link-text">Listen now</span> <span aria-hidden="true">→</span></a>
                    <a href="{{ "podcast" | relURL }}"{{ with .Site.Params.plausible_events.podcast_subscribe }} class="plausible-event-name={{ . }}"{{ end }}><span class="link-text">Subscribe</span> <span aria-hidden="true">→</span></a>
                </div>
            </div>
        </div>
    </section>

      <!-- Recent Essays -->
      {{ if $posts }}
      <section class="recent-essays">
          <h2 class="section-label-small">Recent Essays</h2>
         {{ range first 5 $posts }}
         <article class="essay-item">
             <a href="{{ .RelPermalink }}">
                 <time datetime="{{ .Date.Format "2006-01-02" }}" class="essay-date">{{ .Date.Format "2006 · 01" }}</time>
                 <span class="essay-title">{{ .Title }}</span>
             </a>
         </article>
         {{ end }}
         <div class="all-essays"><a href="{{ "essays" | relURL }}" class="cta-link{{ with .Site.Params.plausible_events.all_essays }} plausible-event-name={{ . }}{{ end }}"><span class="link-text">All essays</span> <span aria-hidden="true">→</span></a></div>
     </section>
      {{ else }}
      <section class="recent-essays">
          <h2 class="section-label-small">Recent Essays</h2>
          <p>No essays published yet.</p>
      </section>
      {{ end }}
{{ end }}
