{{/*
Purpose: Unified writing page at /writing/

Essays: expanded blocks (h3 title + description + meta) — reuses .latest-essay h3 pattern
Notes: compact rows — reuses .note-item/.note-title/.note-date pattern from homepage
Topics: nav links at top
Clustering: consecutive notes grouped via $.Scratch state tracking
*/}}

{{ define "main" }}
    {{ partial "page-title.html" . }}

    {{ with .Content }}
    <div class="page-intro">
        {{ . }}
    </div>
    {{ end }}

    {{/* Topic navigation — brand-orange discipline map */}}
    {{ if .Site.Taxonomies.topics }}
    <nav class="writing-topics" aria-label="Browse by topic">
        {{ range .Site.Taxonomies.topics }}<a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a> <span class="topic-sep" aria-hidden="true">·</span> {{ end }}
    </nav>
    {{ end }}

    {{/* Collect all essays and notes, filter drafts in production */}}
    {{ $essays := where .Site.RegularPages "Type" "essays" }}
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ if not hugo.IsServer }}
        {{ $essays = where $essays "Draft" false }}
        {{ $notes = where $notes "Draft" false }}
    {{ end }}

    {{/* Merge, sort by date descending, and paginate */}}
    {{ $allWriting := union $essays $notes }}
    {{ $allWriting = sort $allWriting "Date" "desc" }}
    {{ $paginator := .Paginate $allWriting }}

    <section class="writing-stream">
        {{/* Track note clustering state */}}
        {{ $.Scratch.Set "inCluster" false }}

        {{ range $paginator.Pages }}
        {{ if eq .Type "essays" }}
            {{/* Close any open note cluster before an essay */}}
            {{ if $.Scratch.Get "inCluster" }}
            </div>
            {{ $.Scratch.Set "inCluster" false }}
            {{ end }}

            {{/* Essay block — reuses .latest-essay h3 a pattern */}}
            <article class="writing-essay">
                <header>
                    <h3><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                </header>
                {{ with .Params.description }}<p class="writing-essay-desc">{{ . }}</p>{{ end }}
                <div class="writing-essay-meta">
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                    {{ with .ReadingTime }}<span class="writing-essay-readtime">{{ . }} min</span>{{ end }}
                </div>
            </article>
        {{ else }}
            {{/* Open a note cluster if not already in one */}}
            {{ if not ($.Scratch.Get "inCluster") }}
            <div class="writing-notes-cluster">
            {{ $.Scratch.Set "inCluster" true }}
            {{ end }}

            {{/* Note row — reuses .note-item pattern from homepage */}}
            <article class="note-item">
                <a href="{{ .RelPermalink }}">
                    <time class="note-date" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                    <span class="note-title">{{ .Title }}</span>
                </a>
            </article>
        {{ end }}
        {{ end }}

        {{/* Close final note cluster if the page ends with notes */}}
        {{ if $.Scratch.Get "inCluster" }}
        </div>
        {{ end }}
    </section>

    {{/* Pagination — uses site action link style for consistency */}}
    {{ if or $paginator.HasPrev $paginator.HasNext }}
    <div class="writing-pagination">
        {{ if $paginator.HasPrev }}
        {{- partial "links/action.html" (dict "url" $paginator.Prev.URL "text" "Recent") -}}
        {{ end }}
        {{ if $paginator.HasNext }}
        {{- partial "links/action.html" (dict "url" $paginator.Next.URL "text" "More") -}}
        {{ end }}
    </div>
    {{ end }}
{{ end }}
