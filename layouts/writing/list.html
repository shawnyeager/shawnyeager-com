{{/*
Purpose: Unified writing page at /writing/

All essays and notes in a single chronological stream, newest first.
Paginated. Two tiers:
  - Hero items (has hero_image): image + title + description — visual anchors
  - Text-only items: date + title — scannable index rows
Per-page CSS classes from .Type for correct styling.
*/}}

{{ define "main" }}
    {{ partial "page-title.html" . }}

    {{ with .Content }}
    <div class="page-intro">
        {{ . }}
    </div>
    {{ end }}

    {{/* Collect all essays and notes, filter drafts in production */}}
    {{ $essays := where .Site.RegularPages "Type" "essays" }}
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ if not hugo.IsServer }}
        {{ $essays = where $essays "Draft" false }}
        {{ $notes = where $notes "Draft" false }}
    {{ end }}

    {{/* Merge, sort by date descending, and paginate */}}
    {{ $allWriting := union $essays $notes }}
    {{ $allWriting = sort $allWriting "Date" "desc" }}
    {{ $paginator := .Paginate $allWriting }}

    <section class="writing-list">
        {{ range $index, $page := $paginator.Pages }}
        {{ $singular := cond (eq .Type "notes") "note" "essay" }}
        {{ $hasHero := .Params.hero_image }}
        <article class="{{ $singular }}-item{{ if $hasHero }} has-hero{{ end }}">
            {{ if $hasHero }}
                {{ $img := resources.Get .Params.hero_image }}
                {{ if $img }}
                    {{ $resized := $img.Resize "800x" }}
                    {{ $webp := $resized.Process "webp q85" }}
                    <a href="{{ .RelPermalink }}" class="{{ $singular }}-hero-link">
                        <img
                            src="{{ $webp.RelPermalink }}"
                            alt="{{ .Params.hero_alt | default .Title }}"
                            class="{{ $singular }}-list-hero"
                            {{ if eq $index 0 }}fetchpriority="high"{{ else }}loading="lazy"{{ end }}
                            width="{{ $resized.Width }}"
                            height="{{ $resized.Height }}"
                        >
                    </a>
                {{ end }}
                <a href="{{ .RelPermalink }}" class="{{ $singular }}-title-link">
                    <span class="{{ $singular }}-title">{{ .Title }}</span>
                </a>
                {{ with .Params.description }}<p class="{{ $singular }}-excerpt">{{ . }}</p>{{ end }}
            {{ else }}
                <a href="{{ .RelPermalink }}">
                    <time datetime="{{ .Date.Format "2006-01-02" }}" class="{{ $singular }}-date">{{ .Date.Format "2006 · 01" }}</time>
                    <span class="{{ $singular }}-title">{{ .Title }}</span>
                </a>
            {{ end }}
        </article>
        {{ end }}
    </section>

    <nav class="writing-nav" aria-label="Browse writing">
        {{ if .Site.Taxonomies.topics }}
        <div class="topic-tags">
            {{ range .Site.Taxonomies.topics }}
            <a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a>
            {{ end }}
        </div>
        {{ end }}
        {{ if or $paginator.HasPrev $paginator.HasNext }}
        <div class="writing-nav-pagination">
            {{ if $paginator.HasPrev }}
            <a href="{{ $paginator.Prev.URL }}" class="pagination-prev" aria-label="Go to previous page: Recent"><span class="arrow" aria-hidden="true">←</span><span class="link-text">Recent</span></a>
            {{ end }}
            {{ if $paginator.HasNext }}
            <a href="{{ $paginator.Next.URL }}" class="pagination-next" aria-label="Go to next page: More"><span class="link-text">More</span><span class="arrow" aria-hidden="true">→</span></a>
            {{ end }}
        </div>
        {{ end }}
    </nav>
{{ end }}
