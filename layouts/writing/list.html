{{/*
Purpose: Unified writing page at /writing/

"Rhythm Break" pattern:
  - Essays: full blocks (title + description + meta) — breathe
  - Notes: compact single-line rows (date + title) — cluster
  - Topics: typographic nav at top, linking to /topics/ pages
*/}}

{{ define "main" }}
    {{ partial "page-title.html" . }}

    {{ with .Content }}
    <div class="page-intro">
        {{ . }}
    </div>
    {{ end }}

    {{/* Topic navigation — editorial section headers */}}
    {{ if .Site.Taxonomies.topics }}
    <nav class="writing-topics" aria-label="Browse by topic">
        {{ range .Site.Taxonomies.topics }}
        <a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a>
        {{ end }}
    </nav>
    {{ end }}

    {{/* Collect all essays and notes, filter drafts in production */}}
    {{ $essays := where .Site.RegularPages "Type" "essays" }}
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ if not hugo.IsServer }}
        {{ $essays = where $essays "Draft" false }}
        {{ $notes = where $notes "Draft" false }}
    {{ end }}

    {{/* Merge, sort by date descending, and paginate */}}
    {{ $allWriting := union $essays $notes }}
    {{ $allWriting = sort $allWriting "Date" "desc" }}
    {{ $paginator := .Paginate $allWriting }}

    <section class="writing-stream">
        {{ range $paginator.Pages }}
        {{ if eq .Type "essays" }}
        {{/* Essay block — title, description, meta line with reading time and topics */}}
        <article class="writing-essay">
            <a href="{{ .RelPermalink }}" class="writing-essay-title">{{ .Title }}</a>
            {{ with .Params.description }}<p class="writing-essay-desc">{{ . }}</p>{{ end }}
            <div class="writing-essay-meta">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                {{ with .ReadingTime }}<span class="writing-essay-readtime">{{ . }} min</span>{{ end }}
                {{ with .GetTerms "topics" }}
                <span class="writing-essay-topics">
                    {{ range . }}<a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>{{ end }}
                </span>
                {{ end }}
            </div>
        </article>
        {{ else }}
        {{/* Note row — compact date + title */}}
        <article class="writing-note">
            <a href="{{ .RelPermalink }}">
                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                <span class="writing-note-title">{{ .Title }}</span>
            </a>
        </article>
        {{ end }}
        {{ end }}
    </section>

    {{/* Pagination */}}
    {{ if or $paginator.HasPrev $paginator.HasNext }}
    <nav class="writing-pagination" aria-label="Browse writing">
        {{ if $paginator.HasPrev }}
        <a href="{{ $paginator.Prev.URL }}" class="pagination-prev" aria-label="Go to previous page: Recent"><span class="arrow" aria-hidden="true">←</span><span class="link-text">Recent</span></a>
        {{ end }}
        {{ if $paginator.HasNext }}
        <a href="{{ $paginator.Next.URL }}" class="pagination-next" aria-label="Go to next page: More"><span class="link-text">More</span><span class="arrow" aria-hidden="true">→</span></a>
        {{ end }}
    </nav>
    {{ end }}
{{ end }}
