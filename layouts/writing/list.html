{{/*
Purpose: Unified writing page at /writing/

"Rhythm Break" v2:
  - Essays: accent bar + large title + description + meta — open, substantial
  - Notes: clustered in card containers — enclosed, compact
  - Topics: brand-orange discipline map at top
  - Clustering: consecutive notes grouped via $.Scratch state tracking
*/}}

{{ define "main" }}
    {{ partial "page-title.html" . }}

    {{ with .Content }}
    <div class="page-intro">
        {{ . }}
    </div>
    {{ end }}

    {{/* Topic navigation — brand-orange discipline map */}}
    {{ if .Site.Taxonomies.topics }}
    <nav class="writing-topics" aria-label="Browse by topic">
        {{ range .Site.Taxonomies.topics }}
        <a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a>
        {{ end }}
    </nav>
    {{ end }}

    {{/* Collect all essays and notes, filter drafts in production */}}
    {{ $essays := where .Site.RegularPages "Type" "essays" }}
    {{ $notes := where .Site.RegularPages "Type" "notes" }}
    {{ if not hugo.IsServer }}
        {{ $essays = where $essays "Draft" false }}
        {{ $notes = where $notes "Draft" false }}
    {{ end }}

    {{/* Merge, sort by date descending, and paginate */}}
    {{ $allWriting := union $essays $notes }}
    {{ $allWriting = sort $allWriting "Date" "desc" }}
    {{ $paginator := .Paginate $allWriting }}

    <section class="writing-stream">
        {{/* Track note clustering state */}}
        {{ $.Scratch.Set "inCluster" false }}

        {{ range $paginator.Pages }}
        {{ if eq .Type "essays" }}
            {{/* Close any open note cluster before an essay */}}
            {{ if $.Scratch.Get "inCluster" }}
            </div>
            {{ $.Scratch.Set "inCluster" false }}
            {{ end }}

            {{/* Essay block — accent bar + title + description + meta */}}
            <article class="writing-essay">
                <a href="{{ .RelPermalink }}" class="writing-essay-title">{{ .Title }}</a>
                {{ with .Params.description }}<p class="writing-essay-desc">{{ . }}</p>{{ end }}
                <div class="writing-essay-meta">
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                    {{ with .ReadingTime }}<span class="writing-essay-readtime">{{ . }} min</span>{{ end }}
                    {{ with .GetTerms "topics" }}
                    <span class="writing-essay-topics">
                        {{ range . }}<a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>{{ end }}
                    </span>
                    {{ end }}
                </div>
            </article>
        {{ else }}
            {{/* Open a note cluster if not already in one */}}
            {{ if not ($.Scratch.Get "inCluster") }}
            <div class="writing-notes-cluster">
            {{ $.Scratch.Set "inCluster" true }}
            {{ end }}

            {{/* Note row — compact date + title */}}
            <article class="writing-note">
                <a href="{{ .RelPermalink }}">
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2006" }}</time>
                    <span class="writing-note-title">{{ .Title }}</span>
                </a>
            </article>
        {{ end }}
        {{ end }}

        {{/* Close final note cluster if the page ends with notes */}}
        {{ if $.Scratch.Get "inCluster" }}
        </div>
        {{ end }}
    </section>

    {{/* Pagination */}}
    {{ if or $paginator.HasPrev $paginator.HasNext }}
    <nav class="writing-pagination" aria-label="Browse writing">
        {{ if $paginator.HasPrev }}
        <a href="{{ $paginator.Prev.URL }}" class="pagination-prev" aria-label="Go to previous page: Recent"><span class="arrow" aria-hidden="true">←</span><span class="link-text">Recent</span></a>
        {{ end }}
        {{ if $paginator.HasNext }}
        <a href="{{ $paginator.Next.URL }}" class="pagination-next" aria-label="Go to next page: More"><span class="link-text">More</span><span class="arrow" aria-hidden="true">→</span></a>
        {{ end }}
    </nav>
    {{ end }}
{{ end }}
